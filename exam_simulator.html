<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCA SUSE 15 - Simulator Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0/index.min.js"></script>
    <!-- <script>MobileDragDrop.polyfill({dragImageTranslateOverride:0});</script> -->

    <style>
        :root { --primary: #0c322c; --secondary: #30ba78; --bg: #f8fafc; --text: #334155; --white: #ffffff; --border: #e2e8f0; --wrong: #ef4444; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; }
        
        .app-container { width: 100%; max-width: 850px; background: var(--white); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 40px; border: 1px solid var(--border); }
        
        /* HEADER & PROGRESS */
        header { background: var(--primary); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .status-badge { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; }
        .progress-bar { height: 6px; background: #cbd5e1; width: 100%; }
        .progress-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s ease; }

        /* CONTENT AREAS */
        main { padding: 30px; min-height: 400px; }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* START & RESULT */
        .center-screen { text-align: center; padding: 40px 0; }
        .big-btn { background: var(--secondary); color: white; border: none; padding: 15px 40px; font-size: 1.2rem; font-weight: 700; border-radius: 8px; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 0 #258e5c; }
        .big-btn:active { transform: translateY(4px); box-shadow: none; }
        .score-circle { width: 150px; height: 150px; border-radius: 50%; border: 8px solid var(--secondary); display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: 800; color: var(--primary); margin: 20px auto; }
        
        /* QUESTIONS */
        .q-tag { display: inline-block; background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; }
        .q-text { font-size: 1.35rem; font-weight: 600; color: #0f172a; margin-bottom: 30px; line-height: 1.4; }
        
        /* OPTIONS (SINGLE/MULTI) */
        .opt-list { display: flex; flex-direction: column; gap: 10px; }
        .opt-btn { background: white; border: 2px solid var(--border); padding: 15px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s; font-size: 1rem; }
        .opt-btn:hover:not(.disabled) { border-color: #94a3b8; background: #f8fafc; }
        .opt-btn.selected { border-color: var(--primary); background: #f0fdf4; color: #14532d; font-weight: 500; }
        .opt-btn input { margin-right: 15px; transform: scale(1.3); accent-color: var(--primary); }
        .opt-btn.disabled { opacity: 0.7; cursor: not-allowed; }

        /* DRAG & DROP & MATCH */
        .drag-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .drag-col { flex: 1; min-width: 280px; }
        .drag-header { font-weight: 700; color: #64748b; margin-bottom: 10px; text-transform: uppercase; font-size: 0.8rem; }
        .drop-zone { 
            background: #f1f5f9; 
            border: 2px dashed #cbd5e1; 
            border-radius: 8px; 
            min-height: 250px; /* IMPORTANTE: Esto le da altura para que puedas soltar */
            padding: 15px; 
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .drop-zone.drag-over { background: #dcfce7; border-color: var(--secondary); }
        .drag-item { background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #cbd5e1; border-left: 4px solid var(--secondary); cursor: grab; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.05); user-select: none; }
        .drag-item:active { cursor: grabbing; }

        /* MATCH SPECIFIC */
        .match-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; align-items: center; }
        .match-static { background: #e2e8f0; padding: 12px; border-radius: 6px; font-weight: 600; font-size: 0.9rem; }
        .match-drop { min-height: 48px; padding: 4px; border: 2px dashed #cbd5e1; border-radius: 6px; background: white; }
        
        /* INPUT FILL */
        .input-fill { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'Consolas', monospace; }
        .input-fill:focus { border-color: var(--secondary); }

        /* FOOTER & FEEDBACK */
        .feedback { margin-top: 25px; padding: 20px; border-radius: 8px; display: none; animation: fadeIn 0.3s; }
        .feedback.correct { background: #dcfce7; border: 1px solid #bbf7d0; color: #14532d; }
        .feedback.wrong { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; }
        
        footer { border-top: 1px solid var(--border); padding: 20px 30px; display: flex; justify-content: space-between; background: #fcfcfc; }
        .nav-btn { padding: 10px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; border: 1px solid transparent; }
        .btn-sec { color: #64748b; background: transparent; }
        .btn-sec:hover { background: #f1f5f9; }
        .btn-pri { background: var(--primary); color: white; }
        .btn-pri:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 600px) {
            .drag-container { flex-direction: column; }
            .match-row { grid-template-columns: 1fr; }
        }
        /* HOTSPOT / IMAGEN */
        .hotspot-container { position: relative; display: inline-block; max-width: 100%; overflow: hidden; border-radius: 8px; border: 2px solid var(--border); cursor: crosshair; }
        .hotspot-img { display: block; width: 100%; height: auto; user-select: none; }
        .hotspot-pin { 
            position: absolute; width: 30px; height: 30px; 
            background: var(--secondary); border: 2px solid white; 
            border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%); /* Para centrar el pin en el click */
            pointer-events: none; transition: top 0.2s, left 0.2s;
            display: none; /* Oculto hasta que se hace click */
            justify-content: center; align-items: center; font-size: 1.2rem;
        }
        .hotspot-pin.active { display: flex; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>SUSE SCA 15 Simulator</h1>
        <div id="timer-display" style="font-family: monospace; font-size: 1.2rem; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px;">90:00</div>
        
        <div class="status-badge"><span id="curr-q">0</span> / <span id="total-q">0</span></div>
    </header>
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

    <main>
        <div id="start-screen" class="screen active center-screen">
            <h2 style="margin-bottom: 10px;">Exam Simulation</h2>
            <p style="color: #64748b; margin-bottom: 40px;">Mixed questions: Single & Multiple Choice, Drag & Drop, Fill in the blanks and Hotspot.</p>
            <button class="big-btn" onclick="quiz.start()">START EXAM</button>
        </div>

        <div id="quiz-screen" class="screen">
            <div class="q-tag" id="q-type">TYPE</div>
            <div class="q-text" id="q-text">Loading...</div>

            <div id="render-area"></div>

            <div id="feedback" class="feedback"></div>
        </div>

        <div id="result-screen" class="screen center-screen">
            <h2>Exam Completed</h2>
            <div class="score-circle" id="final-score">0%</div>
            <p id="final-msg" style="font-size: 1.1rem; color: #64748b; margin-bottom: 30px;"></p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="nav-btn btn-sec" onclick="location.reload()">Exit</button>
                <button class="big-btn" onclick="location.reload()">Retake</button>
            </div>
        </div>
    </main>

    <footer id="footer" style="display:none;">
        <button class="nav-btn btn-sec" id="btn-prev" onclick="quiz.prev()" disabled>Previous</button>
        <div>
            <button class="nav-btn btn-pri" id="btn-check" onclick="quiz.check()">Submit Answer</button>
            <button class="nav-btn btn-pri" id="btn-next" onclick="quiz.next()" style="display:none;">Next Question</button>
        </div>
    </footer>
</div>

<script> 
    window.examData = []; 

    // ESTA FUNCI√ìN ES LA CLAVE: Recibe el nombre del tema y se lo pega a cada pregunta
    window.loadTopic = function(name, questions) {
        questions.forEach(q => {
            q.topic = name; // Aqu√≠ es donde se guarda el nombre del topic (ej: "02 Overview")
            window.examData.push(q);
        });
        console.log(`Cargado: ${name} (${questions.length} preguntas)`);
    };
</script>

<script src="db/topic_02.js"></script>
<script src="db/topic_03.js"></script>
<script src="db/topic_04.js"></script>
<script src="db/topic_05.js"></script>
<script src="db/topic_06.js"></script>
<script src="db/topic_07.js"></script>
<script src="db/topic_08.js"></script>
<script src="db/topic_09.js"></script>
<script src="db/topic_10.js"></script>
<script src="db/topic_11.js"></script>
<script src="db/topic_12.js"></script>
<script src="db/topic_13.js"></script>
<script src="db/topic_14.js"></script>
<script src="db/topic_15.js"></script>
<script src="db/topic_16.js"></script>
<script src="db/topic_17.js"></script>
<script src="db/topic_18.js"></script>
<script>console.log("Questions loaded:", window.examData.length);</script>

<script>


// =============================================================================
//  ENGINE LOGIC - PRO VERSION 2.0 (Balanced & Reporting)
// =============================================================================
const quiz = {
    list: [],
    idx: 0,
    answers: {},
    timer: null,
    timeLeft: 5400,

    start() {
        if (!window.examData || window.examData.length === 0) {
            alert("Error: No questions loaded. Check your 'db' folder.");
            return;
        }

        // --- ALGORITMO DE REPARTO EQUITATIVO ---
        
        // 1. Agrupar preguntas por tema
        const questionsByTopic = {};
        window.examData.forEach(q => {
            const t = q.topic || "Unknown Topic";
            if (!questionsByTopic[t]) questionsByTopic[t] = [];
            questionsByTopic[t].push(q);
        });

        let finalSelection = [];
        let remainingPool = [];

        // 2. Seleccionar 2 preguntas obligatorias de cada tema (si hay)
        Object.keys(questionsByTopic).forEach(topic => {
            // Barajar las preguntas de este tema
            const shuffled = questionsByTopic[topic].sort(() => Math.random() - 0.5);
            
            // Coger las 2 primeras para el examen
            const guaranteed = shuffled.slice(0, 2);
            finalSelection = finalSelection.concat(guaranteed);
            
            // El resto van al "pool" general para rellenar
            remainingPool = remainingPool.concat(shuffled.slice(2));
        });

        // 3. Rellenar hasta llegar a 70
        const questionsNeeded = 70 - finalSelection.length;
        if (questionsNeeded > 0) {
            // Barajar el pool restante
            remainingPool.sort(() => Math.random() - 0.5);
            // Coger las que faltan
            finalSelection = finalSelection.concat(remainingPool.slice(0, questionsNeeded));
        }

        // 4. Barajar la selecci√≥n final para que los temas salgan mezclados
        this.list = finalSelection.sort(() => Math.random() - 0.5);

        // --- INICIO STANDARD ---
        this.idx = 0;
        this.answers = {};
        clearInterval(this.timer);
        this.timeLeft = 90 * 60; 
        this.startTimer();

        document.getElementById('total-q').innerText = this.list.length;
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('quiz-screen').classList.add('active');
        document.getElementById('footer').style.display = 'flex';
        this.load();
    },

    startTimer() {
        const display = document.getElementById('timer-display');
        this.updateTimerDisplay(display);
        this.timer = setInterval(() => {
            this.timeLeft--;
            this.updateTimerDisplay(display);
            if (this.timeLeft <= 0) { clearInterval(this.timer); this.finish(true); }
        }, 1000);
    },

    updateTimerDisplay(display) {
        const m = Math.floor(this.timeLeft / 60);
        const s = this.timeLeft % 60;
        display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        display.style.background = (this.timeLeft < 300) ? '#ef4444' : 'rgba(255,255,255,0.15)';
    },

    load() {
        const q = this.list[this.idx];
        const answered = this.answers[this.idx];
        
        document.getElementById('curr-q').innerText = this.idx + 1;
        document.getElementById('progress').style.width = ((this.idx / this.list.length) * 100) + '%';
        // Mostrar el Topic adem√°s del tipo
        document.getElementById('q-type').innerHTML = `<span style="opacity:0.7">${q.topic || 'General'}</span> &nbsp;|&nbsp; ${q.type}`;
        document.getElementById('q-text').innerText = q.text;
        
        document.getElementById('btn-prev').disabled = (this.idx === 0);
        document.getElementById('btn-check').style.display = answered ? 'none' : 'block';
        document.getElementById('btn-next').style.display = answered ? 'block' : 'none';
        
        const area = document.getElementById('render-area');
        area.innerHTML = '';
        document.getElementById('feedback').style.display = 'none';

        if(q.type === 'SINGLE' || q.type === 'MULTI') this.renderOptions(q, area, answered);
        else if(q.type === 'FILL') this.renderFill(q, area, answered);
        else if(q.type === 'ORDER') this.renderOrder(q, area, answered);
        else if(q.type === 'MATCHING') this.renderMatch(q, area, answered);
        else if(q.type === 'HOTSPOT') this.renderHotspot(q, area, answered);

        if(answered) this.showFeedback(answered.isCorrect, q.rationale);
    },

    // ... (renderOptions, renderFill, renderOrder, renderMatch, renderHotspot, check, showFeedback, next, prev SE QUEDAN IGUAL QUE ANTES) ...
    // ... COPIA AQU√ç ESAS FUNCIONES DEL C√ìDIGO ANTERIOR PARA NO HACER ESTO MUY LARGO ...
    // Si necesitas que las pegue enteras d√≠melo, pero son id√©nticas a la versi√≥n anterior.

    renderOptions(q, container, prevAns) {
        const div = document.createElement('div'); div.className = 'opt-list';
        const isMulti = q.type === 'MULTI';
        q.options.forEach((opt, i) => {
            const btn = document.createElement('div'); btn.className = 'opt-btn';
            if(prevAns) btn.classList.add('disabled');
            let isChecked = prevAns && prevAns.userSel.includes(i);
            btn.innerHTML = `<input type="${isMulti?'checkbox':'radio'}" name="opt" ${isChecked?'checked':''} ${prevAns?'disabled':''}> ${opt.text}`;
            if(isChecked) btn.classList.add('selected');
            if(!prevAns) {
                btn.onclick = (e) => {
                    const inp = btn.querySelector('input');
                    if(e.target !== inp) {
                        if(isMulti) inp.checked = !inp.checked;
                        else { 
                            div.querySelectorAll('input').forEach(x => x.checked = false);
                            div.querySelectorAll('.opt-btn').forEach(x => x.classList.remove('selected'));
                            inp.checked = true; 
                        }
                    }
                    if(isMulti) btn.classList.toggle('selected', inp.checked);
                    else btn.classList.add('selected');
                };
            }
            div.appendChild(btn);
        });
        container.appendChild(div);
    },

    renderFill(q, container, prevAns) {
        const inp = document.createElement('input'); inp.type = 'text'; inp.className = 'input-fill';
        inp.placeholder = 'Type your answer...';
        if(prevAns) { inp.value = prevAns.userVal; inp.disabled = true; }
        container.appendChild(inp);
    },

    renderOrder(q, container, prevAns) {
        const wrap = document.createElement('div'); wrap.className = 'drag-container';
        const col1 = document.createElement('div'); col1.className = 'drag-col'; col1.innerHTML = `<div class="drag-header">OPTIONS</div>`;
        const zoneSrc = document.createElement('div'); zoneSrc.className = 'drop-zone';
        const col2 = document.createElement('div'); col2.className = 'drag-col'; col2.innerHTML = `<div class="drag-header">YOUR ANSWER</div>`;
        const zoneTgt = document.createElement('div'); zoneTgt.className = 'drop-zone'; zoneTgt.id = 'drag-tgt';

        let items = prevAns ? [] : [...q.items].sort(() => Math.random() - 0.5);
        let userItems = prevAns ? prevAns.userOrder : [];

        const createItem = (txt, locked) => {
            const el = document.createElement('div'); el.className = 'drag-item'; el.innerText = txt;
            if(!locked) { el.draggable = true; el.ondragstart = (e) => e.dataTransfer.setData('text', txt); } 
            else { el.style.cursor='default'; el.style.opacity='0.8'; }
            return el;
        };
        items.forEach(t => zoneSrc.appendChild(createItem(t, false)));
        userItems.forEach(t => zoneTgt.appendChild(createItem(t, true)));

        if(!prevAns) {
            [zoneSrc, zoneTgt].forEach(zone => {
                zone.ondragover = e => { e.preventDefault(); zone.classList.add('drag-over'); };
                zone.ondragleave = () => zone.classList.remove('drag-over');
                zone.ondrop = e => {
                    e.preventDefault(); zone.classList.remove('drag-over');
                    const txt = e.dataTransfer.getData('text');
                    const all = document.querySelectorAll('.drag-item');
                    let dragged; all.forEach(x => { if(x.innerText === txt) dragged = x; });
                    if(dragged) zone.appendChild(dragged);
                };
            });
        }
        col1.appendChild(zoneSrc); col2.appendChild(zoneTgt); wrap.appendChild(col1); wrap.appendChild(col2); container.appendChild(wrap);
    },

    renderMatch(q, container, prevAns) {
        const grid = document.createElement('div');
        const userMatches = prevAns ? prevAns.matches : {}; 
        q.pairs.forEach(p => {
            const row = document.createElement('div'); row.className = 'match-row';
            const term = document.createElement('div'); term.className = 'match-static'; term.innerText = p.term;
            const slot = document.createElement('div'); slot.className = 'match-drop drop-zone'; slot.dataset.term = p.term;
            if(prevAns && userMatches[p.term]) {
                const filled = document.createElement('div'); filled.className = 'drag-item'; 
                filled.innerText = userMatches[p.term]; filled.style.cursor='default'; slot.appendChild(filled);
            }
            if(!prevAns) {
                slot.ondragover = e => { e.preventDefault(); slot.classList.add('drag-over'); };
                slot.ondragleave = () => slot.classList.remove('drag-over');
                slot.ondrop = e => {
                    e.preventDefault(); slot.classList.remove('drag-over');
                    const txt = e.dataTransfer.getData('text/plain');
                    if(slot.children.length === 0) {
                        const el = document.querySelector(`.pool-item[data-val="${txt}"]`); if(el) slot.appendChild(el);
                    }
                };
            }
            row.appendChild(term); row.appendChild(slot); grid.appendChild(row);
        });
        container.appendChild(grid);
        if(!prevAns) {
            const pool = document.createElement('div'); pool.style.marginTop = '20px'; pool.style.display = 'flex'; pool.style.gap='10px'; pool.style.flexWrap='wrap'; pool.className = 'drop-zone';
            q.pairs.map(p => p.def).sort(() => Math.random() - 0.5).forEach(def => {
                const el = document.createElement('div'); el.className = 'drag-item pool-item';
                el.draggable = true; el.innerText = def; el.dataset.val = def;
                el.ondragstart = e => e.dataTransfer.setData('text/plain', def); pool.appendChild(el);
            });
            pool.ondragover = e => e.preventDefault();
            pool.ondrop = e => { e.preventDefault(); const txt = e.dataTransfer.getData('text/plain'); const el = document.querySelector(`.pool-item[data-val="${txt}"]`); if(el) pool.appendChild(el); }
            container.appendChild(pool);
        }
    },

    renderHotspot(q, container, prev) {
        const wrap = document.createElement('div'); wrap.style.textAlign = 'center';
        const area = document.createElement('div'); area.className = 'hotspot-container';
        const img = document.createElement('img'); img.src = q.image; img.className = 'hotspot-img';
        const pin = document.createElement('div'); pin.className = 'hotspot-pin'; pin.innerHTML = 'üìç';
        if (prev) {
            pin.classList.add('active'); pin.style.left = (prev.x || 0) + '%'; pin.style.top = (prev.y || 0) + '%';
            if (!prev.isCorrect) pin.style.background = '#ef4444'; 
        } else {
            area.onclick = (e) => {
                const rect = area.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                pin.classList.add('active'); pin.style.left = x + '%'; pin.style.top = y + '%'; area.dataset.x = x; area.dataset.y = y;
            };
        }
        area.appendChild(img); area.appendChild(pin); wrap.appendChild(area); container.appendChild(wrap);
    },

    check() {
        const q = this.list[this.idx]; let isCorrect = false; let dataToSave = {};
        if(q.type === 'SINGLE') {
            const opts = document.querySelectorAll('.opt-btn'); let s = -1;
            opts.forEach((o, i) => { if(o.querySelector('input').checked) s = i; });
            if(s > -1 && q.options[s].correct) isCorrect = true; dataToSave = { userSel: [s] };
        } 
        else if(q.type === 'MULTI') {
            const opts = document.querySelectorAll('.opt-btn');
            let userSel = []; let allGood = true;
            opts.forEach((o, i) => { const checked = o.querySelector('input').checked; if(checked) userSel.push(i); if(checked !== q.options[i].correct) allGood = false; });
            if(userSel.length > 0 && allGood) isCorrect = true; dataToSave = { userSel };
        }
        else if(q.type === 'FILL') {
            const val = document.querySelector('.input-fill').value.trim();
            if(q.validAnswers.some(ans => ans.toLowerCase() === val.toLowerCase())) isCorrect = true; dataToSave = { userVal: val };
        }
        else if(q.type === 'ORDER') {
            const el = document.getElementById('drag-tgt'); const current = el ? [...el.children].map(c => c.innerText) : [];
            if(JSON.stringify(current) === JSON.stringify(q.correct)) isCorrect = true; dataToSave = { userOrder: current };
        }
        else if(q.type === 'MATCHING') {
            const slots = document.querySelectorAll('.match-drop'); let hits = 0; let m = {};
            slots.forEach(s => { if(s.children.length > 0) { const txt = s.children[0].innerText; m[s.dataset.term] = txt; const pair = q.pairs.find(p => p.term === s.dataset.term); if(pair && pair.def === txt) hits++; } });
            if(hits === q.pairs.length) isCorrect = true; dataToSave = { matches: m };
        }
        else if(q.type === 'HOTSPOT') {
            const area = document.querySelector('.hotspot-container');
            if(area) { const userX = parseFloat(area.dataset.x || -999); const userY = parseFloat(area.dataset.y || -999);
            if(Math.abs(userX - q.target.x) < 10 && Math.abs(userY - q.target.y) < 10) isCorrect = true; dataToSave = { x: userX, y: userY }; }
        }
        this.answers[this.idx] = { isCorrect, ...dataToSave }; this.showFeedback(isCorrect, q.rationale); this.load();
    },

    showFeedback(isCorrect, text) {
        const fb = document.getElementById('feedback'); fb.style.display = 'block'; fb.className = `feedback ${isCorrect ? 'correct' : 'wrong'}`;
        fb.innerHTML = `<strong>${isCorrect ? 'Correct!' : 'Incorrect.'}</strong> ${text}`;
        document.getElementById('btn-check').style.display = 'none'; document.getElementById('btn-next').style.display = 'block';
    },

    next() { if(this.idx < this.list.length - 1) { this.idx++; this.load(); } else { this.finish(); } },
    prev() { if(this.idx > 0) { this.idx--; this.load(); } },

    finish(forced = false) {
        clearInterval(this.timer);
        document.getElementById('quiz-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        document.getElementById('footer').style.display = 'none';

        // --- C√ÅLCULO DE ESTAD√çSTICAS POR TEMA ---
        const stats = {}; // { "Topic 02": { total: 0, correct: 0 } }
        
        this.list.forEach((q, i) => {
            const ans = this.answers[i];
            const topic = q.topic || "Unknown";
            
            if (!stats[topic]) stats[topic] = { total: 0, correct: 0 };
            
            stats[topic].total++;
            if (ans && ans.isCorrect) stats[topic].correct++;
        });

        // --- RENDERIZADO DEL REPORTE ---
        const totalQ = this.list.length;
        const totalCorrect = Object.values(this.answers).filter(a => a.isCorrect).length;
        const totalPct = Math.round((totalCorrect / totalQ) * 100);

        document.getElementById('final-score').innerText = totalPct + '%';
        
        // Tabla detallada
        let tableHTML = `
            <div style="margin-top:30px; text-align:left; max-height:300px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px;">
            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                <tr style="background:#f1f5f9; position:sticky; top:0;">
                    <th style="padding:10px; border-bottom:1px solid #cbd5e1;">Topic</th>
                    <th style="padding:10px; border-bottom:1px solid #cbd5e1; text-align:center;">Score</th>
                    <th style="padding:10px; border-bottom:1px solid #cbd5e1; text-align:center;">%</th>
                </tr>
        `;

        // Ordenar temas alfab√©ticamente
        Object.keys(stats).sort().forEach(t => {
            const s = stats[t];
            const pct = Math.round((s.correct / s.total) * 100);
            const color = pct >= 70 ? '#16a34a' : '#dc2626';
            
            tableHTML += `
                <tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:8px 10px;">${t}</td>
                    <td style="padding:8px 10px; text-align:center;">${s.correct}/${s.total}</td>
                    <td style="padding:8px 10px; text-align:center; color:${color}; font-weight:bold;">${pct}%</td>
                </tr>
            `;
        });
        tableHTML += `</table></div>`;

        // Bot√≥n de descarga
        const downloadBtn = `<button onclick="quiz.downloadCSV()" class="nav-btn btn-sec" style="margin-top:15px; width:100%; border:1px solid #cbd5e1;">üì• Download Failed Questions Report</button>`;

        const msgDiv = document.getElementById('final-msg');
        if (forced) {
             msgDiv.innerHTML = `<strong style="color:var(--wrong)">TIME UP!</strong><br>${tableHTML}${downloadBtn}`;
        } else {
             msgDiv.innerHTML = `<strong>${totalPct >= 70 ? 'PASSED!' : 'FAILED'}</strong><br>${tableHTML}${downloadBtn}`;
        }
    },

    downloadCSV() {
        // Generar CSV con preguntas falladas
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM para Excel
        csvContent += "Topic,Question,Result,Your Answer\n";

        this.list.forEach((q, i) => {
            const ans = this.answers[i];
            const isCorrect = ans && ans.isCorrect;
            const status = isCorrect ? "CORRECT" : "WRONG";
            const topic = (q.topic || "General").replace(/,/g, ""); // Limpiar comas
            const text = q.text.replace(/,/g, " ").replace(/\n/g, " "); // Limpiar comas y saltos

            // Solo incluimos en el CSV para estudiar (o todo si prefieres)
            // Vamos a incluir TODO para que tengas el reporte completo
            csvContent += `"${topic}","${text}","${status}"\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "SCA_Exam_Report.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
};
</script>

<footer id="footer" style="display:none;">
        <button class="nav-btn btn-sec" id="btn-prev" onclick="quiz.prev()" disabled>Previous</button>

        <button class="nav-btn btn-sec" 
                style="color: #ef4444; border: 1px solid #ef4444; margin: 0 10px;" 
                onclick="if(confirm('Are you sure? Unanswered questions will count as WRONG.')) quiz.finish()">
            üèÅ Finish Now
        </button>

        <div>
            <button class="nav-btn btn-pri" id="btn-check" onclick="quiz.check()">Submit Answer</button>
            <button class="nav-btn btn-pri" id="btn-next" onclick="quiz.next()" style="display:none;">Next Question</button>
        </div>
    </footer>
</body>
</html>